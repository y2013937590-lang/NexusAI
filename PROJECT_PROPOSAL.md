# NexusAI 项目立项文档

## 一、项目概述

### 1.1 项目名称
**NexusAI** - 企业级LLM服务中间件平台

### 1.2 项目定位
NexusAI是一个开箱即用的LLM服务中间件,为不同业务类型的应用提供标准化、可靠、易用的AI能力接入。它基于LangChain4j框架构建,补齐了企业级生产环境所需的治理、编排、监控等能力,让业务系统能够快速集成大模型能力而无需关心底层实现细节。

### 1.3 核心价值

- **开箱即用**: 提供RESTful API和Web控制台,零配置快速接入
- **标准化接口**: 兼容OpenAI API规范,降低迁移成本
- **多租户隔离**: 支持多应用接入,独立配额和数据隔离
- **企业级可靠性**: 内置限流、熔断、降级、缓存等高可用机制
- **成本可控**: Token计量统计、语义缓存、智能路由降低使用成本
- **创新编排能力**: 基于DAG的任务编排引擎,实现复杂AI工作流自动化

---

## 二、要解决的问题

### 2.1 当前痛点

1. **重复建设**: 每个业务系统都要重复实现LLM调用、会话管理、RAG等能力
2. **缺乏治理**: 直接调用LLM API缺少配额管理、成本控制、审计日志
3. **上下文限制**: 传统单会话模式容易丢失上下文或超出token限制
4. **能力单一**: 只有简单的对话能力,缺少知识库、工具调用、多模态等高级功能
5. **可观测性差**: 无法追踪LLM调用的质量、成本、性能瓶颈
6. **安全风险**: 缺少内容审核、Prompt注入防护、敏感信息过滤

### 2.2 目标用户

- **业务开发团队**: 需要快速为产品添加AI能力(智能客服、内容生成、数据分析等)
- **中台团队**: 需要为多个业务线提供统一的AI服务治理平台
- **AI工程师**: 需要实验不同模型、调优Prompt、构建复杂AI工作流

---

## 三、核心功能

### 3.1 基础能力层

#### 3.1.1 对话服务
- **单轮/多轮对话**: 支持上下文记忆的连续对话
- **流式输出**: SSE流式返回,提升用户体验
- **角色系统**: 预设角色模板(客服助手、代码专家、文案写手等)
- **会话管理**: 会话创建、恢复、历史查询

#### 3.1.2 知识库问答 (RAG)
- **知识库管理**: 创建、更新、删除知识库
- **多格式文档**: 支持PDF/Word/TXT/Markdown等格式解析
- **智能检索**: 基于向量相似度的语义检索
- **混合检索**: 结合关键词和语义检索提高召回率
- **知识库版本管理**: 支持知识更新后的版本控制

#### 3.1.3 工具调用 (Function Calling)
- **工具注册**: 业务系统注册自定义工具(API/Function)
- **自动调用**: LLM自动判断何时调用哪个工具
- **结果回填**: 工具执行结果自动回填到对话上下文
- **支持场景**: 天气查询、数据库查询、订单操作等

#### 3.1.4 文本处理
- **智能分类**: 内容分类、情感分析、意图识别
- **信息抽取**: 从文本中提取结构化信息(实体、关系、事件)
- **文本改写**: 摘要生成、扩写、翻译、润色
- **批量处理**: 支持批量文本处理任务

#### 3.1.5 Embedding服务
- **文本向量化**: 将文本转换为高维向量
- **相似度计算**: 计算文本之间的语义相似度
- **批量embedding**: 支持批量文本向量化

#### 3.1.6 多模态能力
- **图片理解**: 图片描述、OCR、图片问答
- **语音处理**: 语音转文字(ASR)、文字转语音(TTS)
- **文档解析**: PDF/Word等复杂文档的布局理解

### 3.2 创新能力层 - 任务编排引擎 (核心差异化)

#### 3.2.1 设计理念
借鉴`CompletableFuture`的异步编排思想,将复杂问题自动拆解为DAG(有向无环图),通过多阶段独立会话执行,避免上下文丢失和token浪费。

#### 3.2.2 执行流程

```
用户提问
   ↓
【阶段1: 任务规划】
LLM分析问题,生成执行DAG
   ↓
【阶段2: 并行编排执行】
根据依赖关系调度子任务
- 无依赖任务并行执行
- 有依赖任务串行执行
- 每个子任务独立会话
   ↓
【阶段3: 结果聚合】
将所有子任务结果汇总
结合原始问题生成最终答案
   ↓
返回最终结果
```

#### 3.2.3 核心优势

| 对比维度 | 传统单会话 | DAG编排模式 |
|---------|----------|-----------|
| **上下文管理** | 所有内容塞入一个会话,易超限 | 每个子任务独立上下文,按需组合 |
| **并行能力** | 串行处理,耗时长 | 无依赖任务并行,速度提升3-5倍 |
| **成本控制** | 中间过程token浪费严重 | 只传递必要结果,降低30-50%成本 |
| **可追溯性** | 黑盒执行,难以调试 | 清晰的任务DAG,每步可追溯 |
| **容错性** | 失败需全部重来 | 子任务失败独立重试 |

#### 3.2.4 应用场景

- **市场研究报告**: 搜索→数据分析→趋势预测→报告生成
- **代码Review**: 语法检查‖安全扫描‖性能分析→汇总建议
- **多文档问答**: 文档1提取‖文档2提取‖文档3提取→综合回答
- **复杂推理**: 数据提取→多步计算→结果验证→格式化输出
- **内容创作**: 素材搜集‖风格分析→大纲生成→章节写作→全文润色

#### 3.2.5 高级特性

- **条件分支**: 根据中间结果选择不同执行路径
- **循环优化**: 质量不达标时自动优化重试
- **人工审核节点**: 关键决策点插入人工审核
- **动态并发控制**: 根据成本和性能自动调整并发度

### 3.3 治理能力层

#### 3.3.1 应用管理
- **应用注册**: 分配AppKey/AppSecret
- **配额管理**: Token用量限制、QPS限流
- **成本计费**: 按Token/请求次数计费统计
- **权限控制**: 应用级别的功能权限开关

#### 3.3.2 模型管理
- **多模型支持**: OpenAI/Azure/国内大模型(通义千问/文心一言/ChatGLM等)
- **智能路由**: 根据任务类型自动选择最优模型
- **模型降级**: 主模型不可用时自动切换备用模型
- **AB测试**: 支持多模型效果对比实验

#### 3.3.3 Prompt管理
- **模板库**: 预置常用Prompt模板
- **版本管理**: Prompt版本控制和回滚
- **变量替换**: 支持动态变量占位符
- **效果评估**: A/B测试不同Prompt效果

#### 3.3.4 内容安全
- **敏感词过滤**: 自定义敏感词库
- **输入审核**: 检测Prompt注入、越狱攻击
- **输出审核**: 检测生成内容合规性
- **审计日志**: 记录所有输入输出用于审计

#### 3.3.5 语义缓存
- **相似问题识别**: 基于Embedding的语义相似度匹配
- **缓存策略**: TTL过期、LRU淘汰
- **命中率统计**: 监控缓存效果
- **成本节省**: 缓存命中直接返回,节省LLM调用

### 3.4 可观测性

#### 3.4.1 监控面板
- **实时大盘**: QPS、成功率、P99延迟、Token消耗
- **应用维度**: 每个应用的使用量和成本统计
- **模型维度**: 各模型的调用分布和性能对比
- **DAG执行监控**: 任务节点执行状态、耗时、失败原因

#### 3.4.2 链路追踪
- **请求全链路**: API网关→服务层→LangChain4j→LLM
- **性能瓶颈分析**: 定位慢查询和高延迟环节
- **错误追踪**: 异常堆栈和上下文保存

#### 3.4.3 智能告警
- **阈值告警**: Token用量、错误率、延迟异常
- **异常检测**: 基于机器学习的异常流量识别
- **多渠道通知**: 邮件/短信/钉钉/企业微信

---

## 四、技术架构

### 4.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                          业务系统层                               │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐           │
│  │ 客服系统 │  │ 内容平台 │  │ 数据分析 │  │ 办公助手 │  ...      │
│  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘           │
│       │            │            │            │                │
│       └────────────┴────────────┴────────────┘                │
│                          ↓ HTTP/HTTPS API                      │
└─────────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────────┐
│                       API网关层 (Gateway)                        │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐       │
│  │ 认证鉴权  │  │  限流    │  │  路由    │  │ 审计日志  │       │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘       │
└─────────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────────┐
│                      应用服务层 (Services)                        │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐      │
│  │  对话服务      │  │  知识库服务    │  │  工具调用服务  │      │
│  │ ChatService   │  │  RAGService   │  │  ToolService  │      │
│  └───────────────┘  └───────────────┘  └───────────────┘      │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐      │
│  │  文本处理      │  │  向量服务      │  │  多模态服务    │      │
│  │ TextService   │  │EmbedService   │  │ ModalService  │      │
│  └───────────────┘  └───────────────┘  └───────────────┘      │
│  ┌────────────────────────────────────────────────────────┐    │
│  │           任务编排服务 (Orchestration Service)          │    │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐            │    │
│  │  │ Planner  │  │ Executor │  │Aggregator│            │    │
│  │  │ 任务规划  │  │ 任务执行  │  │ 结果聚合  │            │    │
│  │  └──────────┘  └──────────┘  └──────────┘            │    │
│  └────────────────────────────────────────────────────────┘    │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐      │
│  │  应用管理      │  │  模型管理      │  │ Prompt管理    │      │
│  │  AppService   │  │ ModelService  │  │PromptService  │      │
│  └───────────────┘  └───────────────┘  └───────────────┘      │
└─────────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────────┐
│                  LangChain4j引擎层 (Engine)                      │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐      │
│  │  LLM调用引擎   │  │   RAG引擎     │  │  Agent引擎    │      │
│  │  ChatModel    │  │ EmbeddingStore│  │  AiServices   │      │
│  └───────────────┘  └───────────────┘  └───────────────┘      │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐      │
│  │  Memory管理    │  │  工具集成     │  │  流式处理     │      │
│  │ChatMemory     │  │  Tools        │  │  Streaming    │      │
│  └───────────────┘  └───────────────┘  └───────────────┘      │
└─────────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────────┐
│                      基础设施层 (Infrastructure)                  │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐       │
│  │  MySQL   │  │  Redis   │  │ 向量数据库 │  │   OSS    │       │
│  │应用/会话  │  │缓存/限流  │  │Milvus/ES │  │文档存储   │       │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘       │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐       │
│  │ 消息队列  │  │ 监控系统  │  │  日志    │  │  配置中心 │       │
│  │RabbitMQ  │  │Prometheus │  │  ELK     │  │  Nacos   │       │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘       │
└─────────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────────┐
│                    LLM提供商层 (LLM Providers)                   │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐       │
│  │  OpenAI  │  │  Azure   │  │ 通义千问  │  │ 文心一言  │  ...  │
│  │ GPT-4/3.5│  │  GPT-4   │  │Qwen-Max  │  │ERNIE-Bot │       │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘       │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 技术栈选型

#### 4.2.1 核心框架
- **基础框架**: Spring Boot 3.x + Java 17
- **LLM框架**: LangChain4j (多模型抽象、RAG、Agent)
- **API网关**: Spring Cloud Gateway (限流、鉴权、路由)
- **配置中心**: Nacos (动态配置、服务发现)

#### 4.2.2 数据存储
- **关系数据库**: MySQL 8.0 (应用配置、会话历史、计费数据)
- **缓存**: Redis 7.0 (限流计数、语义缓存、分布式锁)
- **向量数据库**: Milvus / Elasticsearch (知识库向量存储)
- **对象存储**: MinIO / 阿里云OSS (文档、图片存储)

#### 4.2.3 中间件
- **消息队列**: RabbitMQ (异步任务、DAG调度)
- **任务调度**: XXL-Job (定时任务、失败重试)
- **搜索引擎**: Elasticsearch (日志检索、全文搜索)

#### 4.2.4 可观测性
- **监控**: Prometheus + Grafana
- **链路追踪**: Micrometer Tracing + Zipkin
- **日志**: ELK Stack (Elasticsearch + Logstash + Kibana)
- **告警**: AlertManager

#### 4.2.5 前端
- **管理控制台**: Vue 3 + Element Plus
- **数据可视化**: ECharts (监控图表)
- **DAG可视化**: AntV X6 (任务编排图)

### 4.3 模块划层

```
nexusai/
├── nexusai-gateway/           # API网关
├── nexusai-service/           # 核心服务层
│   ├── chat-service/          # 对话服务
│   ├── rag-service/           # 知识库服务
│   ├── tool-service/          # 工具调用服务
│   ├── text-service/          # 文本处理
│   ├── embedding-service/     # 向量服务
│   ├── modal-service/         # 多模态服务
│   └── orchestration-service/ # 任务编排服务 ⭐
│       ├── planner/           # 任务规划
│       ├── executor/          # DAG执行引擎
│       ├── aggregator/        # 结果聚合
│       └── monitor/           # 执行监控
├── nexusai-admin/             # 管理服务
│   ├── app-service/           # 应用管理
│   ├── model-service/         # 模型管理
│   ├── prompt-service/        # Prompt管理
│   └── monitor-service/       # 监控服务
├── nexusai-engine/            # LangChain4j引擎封装
├── nexusai-common/            # 通用组件
│   ├── security/              # 安全模块
│   ├── cache/                 # 缓存模块
│   ├── limiter/               # 限流模块
│   └── observability/         # 可观测性
└── nexusai-console/           # Web控制台 (Vue3)
```

### 4.4 数据流示例 - DAG编排执行

```
1. 用户请求
POST /api/v1/orchestration/execute
{
  "question": "分析2024年AI行业趋势并给出投资建议",
  "mode": "auto"
}

2. 任务规划 (Planner)
LLM分析 → 生成DAG
{
  "nodes": [
    {"id": "n1", "type": "search", "instruction": "搜索AI行业报告", "deps": []},
    {"id": "n2", "type": "search", "instruction": "搜索投融资数据", "deps": []},
    {"id": "n3", "type": "analyze", "instruction": "分析趋势", "deps": ["n1","n2"]},
    {"id": "n4", "type": "generate", "instruction": "生成建议", "deps": ["n3"]}
  ]
}

3. 任务调度 (Executor)
Layer 1: [n1, n2] 并行执行 (独立会话)
  ├─ n1: 调用搜索工具 → 返回行业报告内容
  └─ n2: 调用搜索工具 → 返回投融资数据

Layer 2: [n3] 执行 (独立会话, 输入=n1+n2结果)
  └─ n3: LLM分析 → 返回趋势分析结果

Layer 3: [n4] 执行 (独立会话, 输入=n3结果)
  └─ n4: LLM生成 → 返回投资建议

4. 结果聚合 (Aggregator)
Prompt: "原始问题: {question}, 各节点结果: {all_results}"
LLM汇总 → 返回最终答案

5. 返回结果
{
  "execution_id": "exec_123",
  "status": "completed",
  "final_result": "综合分析...",
  "dag_trace": {...},  // 完整执行链路
  "cost": {
    "total_tokens": 15000,
    "total_cost": 0.25
  }
}
```

---

## 五、开发计划

### 5.1 MVP阶段 (2-3个月)

#### Phase 1: 基础设施 (3周)
- [ ] 项目脚手架搭建 (Spring Boot + LangChain4j)
- [ ] 数据库设计 (应用表、会话表、任务表)
- [ ] API网关 (认证、限流、路由)
- [ ] 应用管理 (注册、配额、计费)
- [ ] 基础监控 (Prometheus + Grafana)

#### Phase 2: 核心服务 (4周)
- [ ] 对话服务 (单轮/多轮、流式输出)
- [ ] 模型管理 (多模型接入、智能路由)
- [ ] 知识库服务 (文档解析、向量检索)
- [ ] 语义缓存 (相似度匹配、成本优化)
- [ ] Web控制台 (应用管理、API调试)

#### Phase 3: 编排引擎 (5周) ⭐
- [ ] DAG数据结构设计
- [ ] 任务规划器 (Planner) - LLM生成执行DAG
- [ ] 任务执行引擎 (Executor) - 基于CompletableFuture并行调度
- [ ] 结果聚合器 (Aggregator) - 多节点结果汇总
- [ ] DAG可视化 (实时状态、耗时、成本)

### 5.2 增强阶段 (2-3个月)

#### Phase 4: 高级能力 (6周)
- [ ] 工具调用 (Function Calling)
- [ ] 文本处理 (分类、抽取、改写)
- [ ] Embedding服务
- [ ] Prompt模板管理
- [ ] 内容安全审核

#### Phase 5: 编排高级特性 (4周)
- [ ] 条件分支节点
- [ ] 循环优化节点
- [ ] 人工审核节点
- [ ] 动态并发控制
- [ ] 失败补偿策略

#### Phase 6: 生产化 (4周)
- [ ] 多模态能力 (图片、语音)
- [ ] 高可用架构 (熔断、降级)
- [ ] 完整监控体系 (链路追踪、智能告警)
- [ ] 性能优化 (缓存、批处理)
- [ ] 安全加固 (Prompt注入防护)

### 5.3 里程碑

| 里程碑 | 时间 | 交付物 |
|-------|------|--------|
| **M1: 基础可用** | 第3周 | 支持基础对话、应用管理、API鉴权 |
| **M2: 核心功能** | 第7周 | 支持知识库问答、多模型切换、Web控制台 |
| **M3: 编排引擎** | 第12周 | 支持DAG任务编排、并行执行、可视化 |
| **M4: 功能完善** | 第18周 | 支持工具调用、文本处理、高级编排特性 |
| **M5: 生产就绪** | 第24周 | 完整监控、高可用、安全加固 |

---

## 六、成功指标

### 6.1 功能指标
- ✅ 支持 5+ 主流LLM提供商接入
- ✅ 支持 10+ 常用文档格式解析
- ✅ DAG编排节点类型 ≥ 8种
- ✅ Prompt模板库 ≥ 50个

### 6.2 性能指标
- 🎯 对话接口 P99 延迟 < 3s
- 🎯 RAG检索召回率 > 85%
- 🎯 语义缓存命中率 > 40%
- 🎯 DAG并行执行效率提升 3-5倍

### 6.3 可用性指标
- 🎯 系统可用性 > 99.9%
- 🎯 接口成功率 > 99.5%
- 🎯 故障恢复时间 < 5min

### 6.4 成本指标
- 💰 语义缓存节省成本 30-50%
- 💰 DAG编排降低token消耗 30-40%
- 💰 智能路由降低平均调用成本 20%

---

## 七、风险与挑战

### 7.1 技术风险

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| LLM服务不稳定 | 高 | 多模型降级、本地缓存、熔断保护 |
| DAG规划准确性 | 中 | 提供手动编辑DAG能力、积累最佳实践模板 |
| 向量检索召回率 | 中 | 混合检索、Rerank重排、持续优化chunk策略 |
| Token成本超预算 | 高 | 语义缓存、智能路由、成本预警 |

### 7.2 业务风险

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| 用户接受度 | 高 | 提供详细文档、Demo示例、迁移工具 |
| 竞品对标 | 中 | 突出DAG编排差异化能力、开源社区运营 |
| 内容安全合规 | 高 | 内置审核机制、接入第三方安全服务 |

### 7.3 资源风险

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| 开发人力不足 | 高 | 分阶段迭代、优先MVP核心功能 |
| 基础设施成本 | 中 | 合理架构设计、云资源弹性伸缩 |
| LLM调用成本 | 高 | 配额管理、成本监控告警 |

---

## 八、竞品对比

| 能力维度 | NexusAI | LangChain | Dify | FastGPT |
|---------|---------|-----------|------|---------|
| **任务编排** | ✅ DAG自动编排 | ⚠️ 手动编排 | ⚠️ 简单工作流 | ❌ 不支持 |
| **多租户** | ✅ 企业级隔离 | ❌ | ✅ | ✅ |
| **知识库** | ✅ 混合检索 | ✅ | ✅ | ✅ |
| **工具调用** | ✅ Function Calling | ✅ | ✅ | ✅ |
| **语义缓存** | ✅ | ⚠️ 简单缓存 | ❌ | ❌ |
| **成本优化** | ✅ 智能路由+缓存 | ❌ | ⚠️ 基础统计 | ⚠️ 基础统计 |
| **可观测性** | ✅ 完整监控链路 | ⚠️ 基础日志 | ✅ | ⚠️ |
| **部署方式** | 🐳 私有化+SaaS | 🔧 SDK | 🐳 私有化 | 🐳 私有化 |

**核心差异化**: DAG任务自动编排 + 企业级治理 + 深度成本优化

---

## 九、总结

NexusAI旨在打造一个 **开箱即用、功能完备、具有差异化能力** 的企业级LLM服务中间件。

### 核心亮点
1. **标准化接入**: 兼容OpenAI规范,业务系统零门槛集成
2. **企业级治理**: 多租户、配额管理、成本监控、安全审核
3. **创新编排引擎**: 基于DAG的智能任务拆解与并行执行,解决上下文丢失痛点 ⭐
4. **完整能力矩阵**: 对话/RAG/工具调用/多模态/文本处理全覆盖
5. **深度成本优化**: 语义缓存 + 智能路由 + 并行编排,降低30-50%成本

### 目标用户价值
- **业务开发**: 3行代码接入AI能力,无需关心底层实现
- **AI工程师**: 专注Prompt调优和业务逻辑,基础能力开箱即用
- **中台团队**: 统一管理多业务线AI服务,降低重复建设成本

### 下一步行动
1. 完善详细技术方案设计
2. 搭建项目脚手架和CI/CD流程
3. 启动Phase 1开发 (基础设施 + 核心服务)
4. 同步开发编排引擎原型验证可行性

---

**项目负责人**: [待填写]  
**创建时间**: 2025-01-13  
**版本**: v1.0  
**状态**: 立项中
